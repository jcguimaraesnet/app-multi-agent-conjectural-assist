# Docs for the Azure Web Apps Deploy action: https://github.com/Azure/webapps-deploy
# More GitHub Actions for Azure: https://github.com/Azure/actions
# More info on Python, GitHub Actions, and Azure App Service: https://aka.ms/python-webapps-actions

name: (Agt) agent-conjectural-assist

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/main_agent-conjectural-assist.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read #This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      # üõ†Ô∏è Local Build Section (Optional)
      # The following section in your workflow is designed to catch build issues early on the client side, before deployment. This can be helpful for debugging and validation. However, if this step significantly increases deployment time and early detection is not critical for your workflow, you may remove this section to streamline the deployment process.
      - name: Set up Python and install dependencies
        working-directory: backend
        run: |
          uv python install 3.12
          uv sync
          uv export --frozen --no-hashes -o requirements.txt

      # Oryx uses requirements.txt to install dependencies on Azure App Service.
      # We exclude the .venv directory to reduce the artifact size.
      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: |
            backend/
            !backend/.venv/

      # üö´ Opting Out of Oryx Build
      # If you prefer to disable the Oryx build process during deployment, follow these steps:
      # 1. Remove the SCM_DO_BUILD_DURING_DEPLOYMENT app setting from your Azure App Service Environment variables.
      # 2. Refer to sample workflows for alternative deployment strategies: https://github.com/Azure/actions-workflow-samples/tree/master/AppService
      

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      id-token: write #This is required for requesting the JWT
      contents: read #This is required for actions/checkout

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: python-app
      
      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_B01C81F209C44225A08B90B325BC0FE5 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_AADA19E2185F4E86B8C7200EABDFC903 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_48946C76E3054E279BA8B07693367ABE }}

      - name: 'Deploy to Azure Web App'
        uses: azure/webapps-deploy@v3
        id: deploy-to-webapp
        with:
          app-name: 'agent-conjectural-assist'
          slot-name: 'Production'
          startup-command: 'langgraph dev --host 0.0.0.0 --port 8000 --no-browser'

      - name: Wait for SCM to stabilize
        run: sleep 30

      - name: Configure Azure App Settings
        uses: azure/appservice-settings@v1
        with:
          app-name: 'agent-conjectural-assist'
          app-settings-json: |
            [
              { "name": "LANGSMITH_API_KEY", "value": "${{ secrets.LANGSMITH_API_KEY }}" },
              { "name": "OPENAI_API_KEY", "value": "${{ secrets.OPENAI_API_KEY }}" },
              { "name": "GEMINI_API_KEY", "value": "${{ secrets.GEMINI_API_KEY }}" },
              { "name": "NEXT_PUBLIC_SUPABASE_URL", "value": "${{ vars.NEXT_PUBLIC_SUPABASE_URL }}" },
              { "name": "NEXT_PUBLIC_SUPABASE_ANON_KEY", "value": "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" },
              { "name": "SUPABASE_SERVICE_ROLE_KEY", "value": "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" }
            ]
          